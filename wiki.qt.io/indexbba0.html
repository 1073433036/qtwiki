<!DOCTYPE html>
<html lang="en" dir="ltr" class="client-nojs">

<!-- Mirrored from wiki.qt.io/index.php?title=Assigning_a_file_type_to_an_Application_on_Windows&action=edit by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 05 Nov 2015 10:54:42 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<meta charset="UTF-8" />
<title>View source for Assigning a file type to an Application on Windows - Qt Wiki</title>
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />
<meta name="generator" content="MediaWiki 1.23.3" />
<meta name="robots" content="noindex,nofollow" />
<link rel="shortcut icon" href="http://wiki.qt.io/favicon.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="http://wiki.qt.io/opensearch_desc.php" title="Qt Wiki (en)" />
<link rel="EditURI" type="application/rsd+xml" href="http://wiki.qt.io/api.php?action=rsd" />
<link rel="alternate" type="application/atom+xml" title="Qt Wiki Atom feed" href="http://wiki.qt.io/index.php?title=Special:RecentChanges&amp;feed=atom" />
<link rel="stylesheet" href="http://wiki.qt.io/load.php?debug=false&amp;lang=en&amp;modules=mediawiki.legacy.commonPrint%2Cshared%7Cmediawiki.skinning.interface%7Cmediawiki.ui.button%7Cskins.vector.styles&amp;only=styles&amp;skin=vector&amp;*" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="http://wiki.qt.io/load.php?debug=false&amp;lang=en&amp;modules=site&amp;only=styles&amp;skin=vector&amp;*" />
<style>a:lang(ar),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}
/* cache key: qtio_wiki:resourceloader:filter:minify-css:7:e91d7bc946738c8892a88ad5616a59ba */</style>
<script src="http://wiki.qt.io/load.php?debug=false&amp;lang=en&amp;modules=startup&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"Assigning_a_file_type_to_an_Application_on_Windows","wgTitle":"Assigning a file type to an Application on Windows","wgCurRevisionId":16397,"wgRevisionId":0,"wgArticleId":48,"wgIsArticle":false,"wgIsRedirect":false,"wgAction":"edit","wgUserName":null,"wgUserGroups":["*"],"wgCategories":[],"wgBreakFrames":true,"wgPageContentLanguage":"en","wgPageContentModel":"wikitext","wgSeparatorTransformTable":["",""],"wgDigitTransformTable":["",""],"wgDefaultDateFormat":"dmy","wgMonthNames":["","January","February","March","April","May","June","July","August","September","October","November","December"],"wgMonthNamesShort":["","Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],"wgRelevantPageName":"Assigning_a_file_type_to_an_Application_on_Windows","wgIsProbablyEditable":false,"wgRestrictionEdit":[],"wgRestrictionMove":[],"wgWikiEditorEnabledModules":{"toolbar":true,"dialogs":true,"hidesig":true,"preview":true,"previewDialog":false,"publish":true}});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($,jQuery){mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"editfont":"default","editondblclick":0,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":1,"extendwatchlist":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"imagesize":2,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nickname":"","norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"rcdays":7,"rclimit":50,"rows":25,"showhiddencats":0,"shownumberswatching":1,"showtoolbar":1,"skin":"vector","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"watchcreations":1,"watchdefault":1,"watchdeletion":0,"watchlistdays":3,"watchlisthideanons":0,"watchlisthidebots":0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,
"useeditwarning":1,"prefershttps":1,"usebetatoolbar":1,"usebetatoolbar-cgd":1,"wikieditor-preview":1,"wikieditor-publish":1,"language":"en","variant-gan":"gan","variant-iu":"iu","variant-kk":"kk","variant-ku":"ku","variant-shi":"shi","variant-sr":"sr","variant-tg":"tg","variant-uz":"uz","variant-zh":"zh","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false,"searchNs500":false,"searchNs501":false,"searchNs700":false,"searchNs701":false,"variant":"en"});},{},{});mw.loader.implement("user.tokens",function($,jQuery){mw.user.tokens.set({"editToken":"+\\","patrolToken":false,"watchToken":false});},{},{});
/* cache key: qtio_wiki:resourceloader:filter:minify-js:7:9743cb8b8019d46de5946bfe6dfa04d7 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax","skins.vector.js"]);
}</script>
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/vector/csshover.min.htc")}</style><![endif]--></head>
<body class="mediawiki ltr sitedir-ltr ns-0 ns-subject page-Assigning_a_file_type_to_an_Application_on_Windows skin-vector action-edit vector-animateLayout">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<div id="content" class="mw-body" role="main">
			<a id="top"></a>
			<div id="mw-js-message" style="display:none;"></div>
						<h1 id="firstHeading" class="firstHeading" lang="en"><span dir="auto">View source for Assigning a file type to an Application on Windows</span></h1>
						<div id="bodyContent">
								<div id="contentSub">← <a href="http://wiki.qt.io/Assigning_a_file_type_to_an_Application_on_Windows" title="Assigning a file type to an Application on Windows">Assigning a file type to an Application on Windows</a></div>
												<div id="jump-to-nav" class="mw-jump">
					Jump to:					<a href="#mw-navigation">navigation</a>, 					<a href="#p-search">search</a>
				</div>
				<div id="mw-content-text"><p>You do not have permission to edit this page, for the following reason:
</p>
<div class="permissions-errors">
<p>The action you have requested is limited to users in one of the groups: <a href="http://wiki.qt.io/index.php?title=Qt_Wiki:Users&amp;action=edit&amp;redlink=1" class="new" title="Qt Wiki:Users (page does not exist)">Users</a>, KnowledgeBase, QtWS.
</p>
</div>
<hr />
<p>You can view and copy the source of this page:
</p><textarea readonly="" accesskey="," id="wpTextbox1" cols="80" rows="25" style="" lang="en" dir="ltr" name="wpTextbox1">{{Cleanup | reason=Auto-imported from ExpressionEngine.}}

[[Category:Snippets]]

'''English''' | [[Assigning_a_file_type_to_an_Application_on_Windows_German|Deutsch]]


= Assigning a file type to an Application on Windows =

== Background / technical stuff ==

File types in windows are defined in the Windows registry. First there is the entry of "&lt;extension>" in HKCR which contains the file type name. In HKCRamp;lt;file type name> the different actions are defined.

This means, there is a file extension '''gidoc''', whose files are called "MDI Text Editor Document". These documents should be opened in an application, which is located here: E:.exe. The file itself should be a parameter.

Using this pattern, each double click on a file opens a new Process which gets the file as parameter. This is fine for SDI (Single Document Interface) applications.

Example below:

&lt;code>
HKEY_CLASSES_ROOT
 idoc
 "Default"="GiMdi.Document"
 "NullFile"=""

.Document
 "Default"="MDI Text Editor Document"
 ]
 "Default"="E:.exe,0"
 "Default"="E:.exe %1"
&lt;/code>

For MDI (Multi Document Interfaces), it should be opened in the existing Process. To achieve this, windows uses the old DDE mechanism. There must be some additional entries to achieve this:

&lt;code>
HKEY_CLASSES_ROOT
 .Document
 "Default"="[open(quot;%1quot;)]"
 ]
 "Default"="SimpleCryptIoDevided"
 "Default"="system"
&lt;/code>

If this is also added, Windows starts the process, which is given in command and then sends a WM_DDE_INITIATE broadcast message to windows. The application must react on this, then handle WM_DDE_EXECUTE messages and, if requested, WM_DDE_TERMINATE message. If the reaction on the DDE messages is not correc, Windows displays some error messages.

== How to do it ==

Normally, your application registers the file types (changes the registry) during startup. If the DDE Mdi stuff should be used, it then has to create some ATOMS (::GlobalAddAtom). Then it starts up the rest and waits fo user input.

If the file type is registered, and no dde is set, the application is started with the file path as parameter.

If ddeexec keys are set in the registry, the application is started and the the DDE messages are send. While handling these messages, WM_DDE_ACK messages are send back to the caller and the messages must be handled.

This behaviour and the code would always look the same, only the registration keys and the handling of the DDE commands differ from application to application. There fore I created a class, that does all this and can be used as base class instead of QMainWindow: '''DocumentWindow'''.

== Use the DocumentWindow class ==

If you want to create an (MDI) editor application, you can derive your main window class from DocumentWindow instead of QMainWindow. If you implement an MDI application, you should also reimplement the virtual method &lt;code>ddeOpenFile&lt;/code>.
The example code is based on the [http://doc.qt.nokia.com/4.7/mainwindows-mdi.html Qt MDI Example]

&lt;code>
class MainWindow : public DocumentWindow
{
…
protected:
 virtual void ddeOpenFile(const QString&amp; filePath);
}
&lt;/code>

all other things that need to be done is extending your constructor

&lt;code>
MainWindow::MainWindow(QWidget* parent, Qt::WindowFlags flags) :
 DocumentWindow(parent, flags)
{
 …
 registerFileType("GiMdi.Document", // Document type name
 "MDI Text Editor Document",// User readable file type name
 ".gidoc", // file extension
 0, // index of the icon to use for the files.
 true); // register for DDE events
 enableShellOpen();
 …
}
&lt;/code>

and reimplement ddeFileOpen

&lt;code>
void MainWindow::ddeOpenFile(const QString&amp; filePath)
{
 MdiChild '''child = createMdiChild();
 if (child->loadFile(filePath))
 {
 statusBar()->showMessage(tr("File loaded"), 2000);
 child->show();
 }
 else
 {
 child->close();
 }
}
&lt;/code>

That's it. Now it should work to just start the application, and the file type ".gidoc" is registered with your application. If you double click on it in the Windows explorer, it should be opened in the currently running Process or, if no instance of your application is running, start a new one. If your application has a windows icon in the resource (not in the qrc file! a windows resource file &lt;file>.rc), this icon should be used for the files.

==Use the DocumentWindow sources==

===DocumentWindow.h===

&lt;code>
// ————————————————————————————————-
/**
 * @file
 * @brief
 * @author Gerolf Reinwardt
 * @date 30. march 2011
 *
 * Copyright © 2011, Gerolf Reinwardt. All rights reserved.
 *
 * Simplified BSD License
 *
 * Redistribution and use in source and binary forms, with or without modification, are
 * permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this list of
 * conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice, this list
 * of conditions and the following disclaimer in the documentation and/or other materials
 * provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY &lt;COPYRIGHT HOLDER> ``AS IS'' AND ANY EXPRESS OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL &lt;COPYRIGHT HOLDER> OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * The views and conclusions contained in the software and documentation are those of the
 * authors and should not be interpreted as representing official policies, either expressed
 * or implied, of Gerolf Reinwardt.
 */
// ————————————————————————————————-

#ifndef WIDGET_H
#define WIDGET_H

// —— general includes —————————————————————————
#include &lt;windows.h>
#include &lt;QMainWindow>

// —— local includes —————————————————————————-
// —— pre defines ——————————————————————————-

// —— class definition —————————————————————————
/**
 * @short This class implements a main window with the ability to register file types on MS Windows and
 * react on the corresponding DDE events to open / print the files in an Windows MDI typical manner.
 *
 * The usage is fairly easy. Derive your own MainWindow class from DocumentWindow instead of QMainWindow.
 * Inside your constructor, call registerFileType and enableShellOpen. The axample is build on top of the
 * Qt MDI Example (http://doc.qt.nokia.com/4.7/mainwindows-mdi.html)
 *
 * @code
 MainWindow::MainWindow(QWidget* parent, Qt::WindowFlags flags) :
 DocumentWindow(parent, flags)
 {
 …

registerFileType("GiMdi.Document", "MDI Text Editor Document", ".gidoc", 0, true);
 enableShellOpen();

setWindowTitle(tr("MDI"));
 setUnifiedTitleAndToolBarOnMac(true);
 }
 
 *
 * Aditionally, the actions must be performed by overwriting one or more of:
 * @li ddeOpenFile
 * @li ddeNewFile
 * @li ddePrintFile
 * @li executeUnknownDdeCommand
 *
 * 

 void MainWindow::ddeOpenFile(const QString&amp; filePath)
 {
 MdiChild *child = createMdiChild();
 if (child->loadFile(filePath))
 {
 statusBar()->showMessage(tr("File loaded"), 2000);
 child->show();
 }
 else
 {
 child->close();
 }
 }

*
 */
class DocumentWindow : public QMainWindow
{
 Q_OBJECT
public:
 // —— enums ———————————————————————————
 /**
 * Known DDE command. These commands are typically used
 */
 enum DdeCommand {
 DDEOpen = 0x0001, /&lt; open a file via explorer*/
 DDENew = 0x0002, /**&lt; create a new file via explorer*/
 DDEPrint = 0x0004, /**&lt; print a file via explorer*/
 };
 Q_DECLARE_FLAGS(DdeCommands, DdeCommand)

// —— construction —————————————————————————
 /**
 * Constructor.
 *
 * Creates a DocumentWindow with a given @arg parent and @arg flags.
 */
 explicit DocumentWindow(QWidget* parent = 0, Qt::WindowFlags flags = 0);

/**
 * Destructor
 */
 ~DocumentWindow();

 // —— operators ——————————————————————————
 // —— methods ——————————————————————————-
 // —— accessors ——————————————————————————
 // —— members ——————————————————————————-

protected:
 // —— events ———————————————————————————
 /**
 * reimpl as DDE events come as windows events and are not translated by Qt.
 */
 virtual bool winEvent(MSG *message, long *result);

 // —— helpers for the file registration ——————————————————
 /**
 * virtual function that must be implemented by the derived class to react to the open command
 * from Windows.
 *
 * @param filePath file that was selected in the explorer
 */
 virtual void ddeOpenFile(const QString&amp; filePath);

 /**
 * virtual function that must be implemented by the derived class to react to the new command
 * from Windows.
 *
 * @param filePath file that was selected in the explorer
 */
 virtual void ddeNewFile(const QString&amp; filePath);

 /**
 * virtual function that must be implemented by the derived class to react to the print command
 * from Windows.
 *
 * @param filePath file that was selected in the explorer
 */
 virtual void ddePrintFile(const QString&amp; filePath);

 /**
 * virtual function that must be implemented by get custom dde commands from the explorer. If, e.g.
 * a printo or copy command should be available in explorer and they are registered via registerCommand,
 * this function is called.
 *
 * @param command name of the command
 * @param params parameter string, containing the hole stuff, also " and commas.
 *
 * @note a command like this [compare("%1")] will result in the parameters:
 command = "compare";
 params = "quot;&lt;filepath>quot;";
 */
 virtual void executeUnknownDdeCommand(const QString&amp; command, const QString&amp; params);

 /**
 * Call this method to register the file type in Windows. It creates the default command
 * which means the app is started with the file to open as parameter. If @arg registerForDDE
 * is true, the dde events are also created so the opening of a file is done in typical MDI
 * behavior (all files open in the same app).
 *
 * @param documentId id of the document, typically &lt;Application>.Document —> see in registry, e.g. "GiMdi.Document"
 * @param fileTypeName free name of the file type, e.g. "MDI Text Editor Document"
 * @param fileExtension File extension, including the dot (e.g. ".gidoc")
 * @param appIconIndex index of the app icon to use for the file in the windows explorer, typically the application icon
 * @param registerForDDE true if DDE should be used (typical for MDI apps), typically false for SDI apps.
 * @param commands a combination of the commands to install.
 *
 * @note If more then the default commands are needed, then subsequent calls of registerCommand are needed.
 *
 * @note DDEOpen leads to the DDE command: [open("%1)]
 DDENew leads to the DDE command: [new("%1)]
 DDEPrint leads to the DDE command: [print("%1)]
 */
 void registerFileType(const QString&amp; documentId,
 const QString&amp; fileTypeName,
 const QString&amp; fileExtension,
 qint32 appIconIndex = 0,
 bool registerForDDE = false,
 DdeCommands commands = DDEOpen);

 /**
 * registeres one command for a given file type. It is called for the pre defined DDE command
 * types from registerFileType. if more then the normal commands are needed, it can be called
 * in addition to registerFileType.
 *
 * @code
 MainWindow::MainWindow(QWidget* parent, Qt::WindowFlags flags) :
 DocumentWindow(parent, flags)
 {
 …

registerFileType("GiMdi.Document", "MDI Text Editor Document", ".gidoc", 0, true);
 registerCommand("fancyCommand", "GiMdi.Document", "-fancy %1", "[fancy(quot;%1quot;)]");
 enableShellOpen();

 …
 }
 @endcode
 */
 void registerCommand(const QString&amp; command,
 const QString&amp; documentId,
 const QString cmdLineArg = QString::null,
 const QString ddeCommand = QString::null);

 /**
 * Call this method to enable the user to open data files associated with your application
 * by double-clicking the files in the windows file manager.
 *
 * Use it together with registerFileType to register the fspezified file types or provida a
 * registry file (*.reg) which does this.
*/
 void enableShellOpen();


private:
 // —— privat helpers ————————————————————————
 /**
 * implementation of the WM_DDE_INITIATE windows message
 */
 bool ddeInitiate(MSG* message, long* result);

 /**
 * implementation of the WM_DDE_EXECUTE windows message
 */
 bool ddeExecute(MSG* message, long* result);

 /**
 * implementation of the WM_DDE_TERMINATE windows message
 */
 bool ddeTerminate(MSG* message, long* result);

 /**
 * Sets specified value in the registry under HKCU\Software\Classes, which is mapped to HKCR then.
 */
 bool SetHkcrUserRegKey(QString key, const QString&amp; value, const QString&amp; valueName = QString::null);

 /**
 * this method is called to do the DDE command handling. It does argument splitting and then calls
 * ddeOpenFile, ddeNewFile, ddePrintFile or executeUnknownDdeCommand.
 */
 void executeDdeCommand(const QString&amp; command, const QString&amp; params);

 // —— members ——————————————————————————-
 bool m_registerForDDE; /&lt; used to identfy, if the dde commands should be written to the registry*/
 QString m_appAtomName; /**&lt; the name of the application, without file extension*/
 QString m_systemTopicAtomName; /**&lt; the name of the system topic atom, typically "System"*/
 ATOM m_appAtom; /**&lt; The windows atom needed for DDE communication*/
 ATOM m_systemTopicAtom; /**&lt; The windows system topic atom needed for DDE communication*/
 // —— not allowed members ——————————————————————-
};

Q_DECLARE_OPERATORS_FOR_FLAGS(DocumentWindow::DdeCommands)

#endif // WIDGET_H
&lt;/code>

=== DocumentWindow.cpp ===

&lt;code>
// ————————————————————————————————-
/**
 * @file
 * @brief
 * @author Gerolf Reinwardt
 * @date 30.01.2011
 *
 * Copyright © 2011, Gerolf Reinwardt. All rights reserved.
 *
 * Simplified BSD License
 *
 * Redistribution and use in source and binary forms, with or without modification, are
 * permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice, this list of
 * conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright notice, this list
 * of conditions and the following disclaimer in the documentation and/or other materials
 * provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY &lt;COPYRIGHT HOLDER> ``AS IS'' AND ANY EXPRESS OR IMPLIED
 * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND
 * FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL &lt;COPYRIGHT HOLDER> OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
 * SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
 * ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * The views and conclusions contained in the software and documentation are those of the
 * authors and should not be interpreted as representing official policies, either expressed
 * or implied, of Gerolf Reinwardt.
 */
// ————————————————————————————————-

// —— general includes —————————————————————————
#include &lt;windows.h>
#include &lt;QMessageBox>
#include &lt;QApplication>
#include &lt;QDir>
#include &lt;QFileInfo>
#include &lt;QRegExp>

// —— local includes —————————————————————————-
#include "documentwindow.h"


// —— construction ——————————————————————————
DocumentWindow::DocumentWindow(QWidget''' parent, Qt::WindowFlags flags) :
 QMainWindow(parent, flags),
 m_registerForDDE(false),
 m_appAtomName(),
 m_systemTopicAtomName("system"),
 m_appAtom(0),
 m_systemTopicAtom(0)
{
 QFileInfo fi(qApp->applicationFilePath());
 m_appAtomName = fi.baseName();
}

DocumentWindow::~DocumentWindow()
{
 if(0 != m_appAtom)
 {
 ::GlobalDeleteAtom(m_appAtom);
 m_appAtom = 0;
 }
 if(0 != m_systemTopicAtom)
 {
 ::GlobalDeleteAtom(m_systemTopicAtom);
 m_systemTopicAtom = 0;
 }
}

// —— operators ———————————————————————————
// —— methods ————————————————————————————
// —— accessors ———————————————————————————
// —— public slots ——————————————————————————
// —— protected slots —————————————————————————
// —— events ————————————————————————————
bool DocumentWindow::winEvent(MSG *message, long '''result)
{
 switch(message->message)
 {
 case WM_DDE_INITIATE:
 return ddeInitiate(message, result);
 break;
 case WM_DDE_EXECUTE:
 return ddeExecute(message, result);
 break;
 case WM_DDE_TERMINATE:
 return ddeTerminate(message, result);
 break;
 }

 return QMainWindow::winEvent(message, result);
}

void DocumentWindow::ddeOpenFile(const QString&amp;)
{
 // this method will be overwritten, if the application uses the dde open command
}

void DocumentWindow::ddeNewFile(const QString&amp;)
{
 // this method will be overwritten, if the application uses the dde new command
}

void DocumentWindow::ddePrintFile(const QString&amp;)
{
 // this method will be overwritten, if the application uses the dde print command
}

void DocumentWindow::executeUnknownDdeCommand(const QString&amp;, const QString&amp;)
{
 // this method will be overwritten, if the application uses other commands,
 // then open, new and print via DDE and Explorer
}

void DocumentWindow::registerFileType(const QString&amp; documentId,
 const QString&amp; fileTypeName,
 const QString&amp; fileExtension,
 qint32 appIconIndex,
 bool registerForDDE,
 DdeCommands commands)
{
 // first register the type ID of our server
 if (!SetHkcrUserRegKey(documentId, fileTypeName))
 return;

 if (!SetHkcrUserRegKey(QString("%1DefaultIcon").arg(documentId),
 QString("quot;%1quot;,%2").arg(QDir::toNativeSeparators(qApp->applicationFilePath())).arg(appIconIndex)))
 return;

 m_registerForDDE = registerForDDE;

 if(commands &amp; DDEOpen)
 registerCommand("Open", documentId, "quot;%1quot;", "[open(quot;%1quot;)]");
 if(commands &amp; DDENew)
 registerCommand("New", documentId, "-new quot;%1quot;", "[new(quot;%1quot;)]");
 if(commands &amp; DDEPrint)
 registerCommand("Print", documentId, "-print quot;%1quot;", "[print(quot;%1quot;)]");

 LONG lSize = _MAX_PATH * 2;
 wchar_t szTempBuffer[_MAX_PATH * 2];
 LONG lResult = ::RegQueryValue(HKEY_CLASSES_ROOT,
 (const wchar_t*)fileExtension.utf16(),
 szTempBuffer,
 &amp;lSize);

 QString temp = QString::fromUtf16((unsigned short*)szTempBuffer);

 if (lResult != ERROR_SUCCESS || temp.isEmpty() || temp == documentId)
 {
 // no association for that suffix
 if (!SetHkcrUserRegKey(fileExtension, documentId))
 return;

 SetHkcrUserRegKey(QString("%1ShellNew").arg(fileExtension), QLatin1String(""), QLatin1String("NullFile"));
 }
}

void DocumentWindow::registerCommand(const QString&amp; command,
 const QString&amp; documentId,
 const QString cmdLineArg,
 const QString ddeCommand)
{
 QString commandLine = QDir::toNativeSeparators(qApp->applicationFilePath());
 commandLine.prepend(QLatin1String("quot;"));
 commandLine.append(QLatin1String("quot;"));

 if(!cmdLineArg.isEmpty())
 {
 commandLine.append(QChar(' '));
 commandLine.append(cmdLineArg);
 }

 if (!SetHkcrUserRegKey(QString("%1shell%2command").arg(documentId).arg(command), commandLine))
 return; // just skip it

 if(m_registerForDDE)
 {
 if (!SetHkcrUserRegKey(QString("%1shell%2ddeexec").arg(documentId).arg(command), ddeCommand))
 return;

 if (!SetHkcrUserRegKey(QString("%1shell%2ddeexecapplication").arg(documentId).arg(command), m_appAtomName))
 return;

 if (!SetHkcrUserRegKey(QString("%1shell%2ddeexectopic").arg(documentId).arg(command), m_systemTopicAtomName))
 return;
 }
}

void DocumentWindow::enableShellOpen()
{
 if((0 != m_appAtom) || (0 != m_systemTopicAtom))
 return;

 m_appAtom = ::GlobalAddAtomW((const wchar_t''')m_appAtomName.utf16());
 m_systemTopicAtom = ::GlobalAddAtomW((const wchar_t*)m_systemTopicAtomName.utf16());
}

// —— private slots ——————————————————————————
// —— private helpers —————————————————————————
bool DocumentWindow::ddeInitiate(MSG* message, long* result)
{
 if( (0 != LOWORD (message->lParam)) &amp;&amp;
 (0 != HIWORD (message->lParam)) &amp;&amp;
 (LOWORD (message->lParam)  m_appAtom) &amp;&amp;
        (HIWORD(message->lParam)  m_systemTopicAtom))
 {
 // make duplicates of the incoming atoms (really adding a reference)
 wchar_t atomName[_MAX_PATH];
 Q_ASSERT(::GlobalGetAtomNameW(m_appAtom, atomName, _MAX_PATH - 1) != 0);
 Q_ASSERT(::GlobalAddAtomW(atomName)  m_appAtom);
        Q_ASSERT(::GlobalGetAtomNameW(m_systemTopicAtom, atomName, _MAX_PATH - 1) != 0);
        Q_ASSERT(::GlobalAddAtomW(atomName)  m_systemTopicAtom);

// send the WM_DDE_ACK (caller will delete duplicate atoms)
 ::SendMessage((HWND)message->wParam, WM_DDE_ACK, (WPARAM)winId(), MAKELPARAM (m_appAtom, m_systemTopicAtom));
 }
 '''result = 0;
 return true;
}

bool DocumentWindow::ddeExecute(MSG''' message, long* result)
{
 // unpack the DDE message
 UINT_PTR unused;
 HGLOBAL hData;
 //IA64: Assume DDE LPARAMs are still 32-bit
 Q_ASSERT(::UnpackDDElParam(WM_DDE_EXECUTE, message->lParam, &amp;unused, (UINT_PTR*)&amp;hData));

QString command = QString::fromWCharArray((LPCWSTR)::GlobalLock(hData));
 ::GlobalUnlock(hData);

// acknowledge now - before attempting to execute
 ::PostMessage((HWND)message->wParam, WM_DDE_ACK, (WPARAM)winId(),
 //IA64: Assume DDE LPARAMs are still 32-bit
 ReuseDDElParam(message->lParam, WM_DDE_EXECUTE, WM_DDE_ACK, (UINT)0x8000, (UINT_PTR)hData));

// don't execute the command when the window is disabled
 if (!isEnabled())
 {
 '''result = 0;
 return true;
 }

 QRegExp regCommand("&lt;sup>$");
 if(regCommand.exactMatch(command))
 {
 executeDdeCommand(regCommand.cap(1), regCommand.cap(2));
 }

 '''result = 0;
 return true;
}

bool DocumentWindow::ddeTerminate(MSG''' message, long* result)
{
 // The client or server application should respond by posting a WM_DDE_TERMINATE message.
 ::PostMessageW((HWND)message->wParam, WM_DDE_TERMINATE, (WPARAM)winId(), message->lParam);
 return true;
}

bool DocumentWindow::SetHkcrUserRegKey(QString key, const QString&amp; value, const QString&amp; valueName)
{
 HKEY hKey;

 key.prepend("SoftwareClasses");

 LONG lRetVal = RegCreateKey(HKEY_CURRENT_USER,
 (const wchar_t*)key.utf16(),
 &amp;hKey);

 if(ERROR_SUCCESS == lRetVal)
 {
 LONG lResult = ::RegSetValueExW(hKey,
 valueName.isEmpty() ? 0 : (const wchar_t*)valueName.utf16(),
 0,
 REG_SZ,
 (CONST BYTE*)value.utf16(),
 (value.length() + 1) * sizeof(wchar_t));

 if(::RegCloseKey(hKey)  ERROR_SUCCESS &amp;&amp; lResult  ERROR_SUCCESS)
 return true;

 QMessageBox::warning(0, QString("Error in setting Registry values"),
 QString("registration database update failed for key '%s'.").arg(key));
 }
 else
 {
 wchar_t buffer[4096];
 ::FormatMessageW(FORMAT_MESSAGE_FROM_SYSTEM, 0, lRetVal, 0, buffer, 4096, 0);
 QString szText = QString::fromUtf16((const ushort*)buffer);
 QMessageBox::warning(this, QString("Error in setting Registry values"), szText);
 }
 return false;
}

void DocumentWindow::executeDdeCommand(const QString&amp; command, const QString&amp; params)
{
 QRegExp regCommand("&lt;/sup>quot;(.''')quot;$");
 bool singleCommand = regCommand.exactMatch(params);
 if((0  command.compare("open", Qt::CaseInsensitive)) &amp;&amp; singleCommand)
    {
        ddeOpenFile(regCommand.cap(1));
    }
    else if((0  command.compare("new", Qt::CaseInsensitive)) &amp;&amp; singleCommand)
 {
 ddeNewFile(regCommand.cap(1));
 }
 else if((0 == command.compare("print", Qt::CaseInsensitive)) &amp;&amp; singleCommand)
 {
 ddePrintFile(regCommand.cap(1));
 }
 else
 {
 executeUnknownDdeCommand(command, params);
 }
}

&lt;/code>

You may use this code without any warranty.

== Future extensions ==

The class might be extended so it also works on Linux or Mac. The code of the class and a demo project are located on gitorious in the following repository: [https://www.gitorious.org/qtdevnet-wiki-mvc/qtdevnet-registereditorfiletype qtdevnet-registereditorfiletype]

== Versions ==

The current code is version 1 of the code.

==== Version 1 ====

This marks the first public release.

== Feedback ==
</textarea><div class="templatesUsed"><div class="mw-templatesUsedExplanation"><p>Templates used on this page:
</p></div><ul>
<li><a href="http://wiki.qt.io/Template:Ambox" title="Template:Ambox">Template:Ambox</a> (<a href="http://wiki.qt.io/index.php?title=Template:Ambox&amp;action=edit" title="Template:Ambox">view source</a>) </li><li><a href="http://wiki.qt.io/Template:Cleanup" title="Template:Cleanup">Template:Cleanup</a> (<a href="http://wiki.qt.io/index.php?title=Template:Cleanup&amp;action=edit" title="Template:Cleanup">view source</a>) </li></ul></div><p id="mw-returnto">Return to <a href="http://wiki.qt.io/Assigning_a_file_type_to_an_Application_on_Windows" title="Assigning a file type to an Application on Windows">Assigning a file type to an Application on Windows</a>.</p>
</div>								<div class="printfooter">
				Retrieved from "<a href="http://wiki.qt.io/Assigning_a_file_type_to_an_Application_on_Windows">http://wiki.qt.io/Assigning_a_file_type_to_an_Application_on_Windows</a>"				</div>
												<div id='catlinks' class='catlinks catlinks-allhidden'></div>												<div class="visualClear"></div>
							</div>
		</div>
		<div id="mw-navigation">
			<h2>Navigation menu</h2>
			<div id="mw-head">
				<div id="p-personal" role="navigation" class="" aria-labelledby="p-personal-label">
	<h3 id="p-personal-label">Personal tools</h3>
	<ul>
<li id="pt-anonuserpage"><a href="http://wiki.qt.io/User:10.0.113.70" class="new" title="The user page for the IP address you are editing as [.]" accesskey=".">10.0.113.70</a></li><li id="pt-anontalk"><a href="http://wiki.qt.io/User_talk:10.0.113.70" class="new" title="Discussion about edits from this IP address [n]" accesskey="n">Talk for this IP address</a></li><li id="pt-login"><a href="http://wiki.qt.io/index.php?title=Special:QtLogin&amp;returnto=Assigning+a+file+type+to+an+Application+on+Windows" title="You are encouraged to log in; however, it is not mandatory [o]" accesskey="o">Sign in</a></li>	</ul>
</div>
				<div id="left-navigation">
					<div id="p-namespaces" role="navigation" class="vectorTabs" aria-labelledby="p-namespaces-label">
	<h3 id="p-namespaces-label">Namespaces</h3>
	<ul>
					<li  id="ca-nstab-main" class="selected"><span><a href="http://wiki.qt.io/Assigning_a_file_type_to_an_Application_on_Windows"  title="View the content page [c]" accesskey="c">Page</a></span></li>
					<li  id="ca-talk" class="new"><span><a href="http://wiki.qt.io/index.php?title=Talk:Assigning_a_file_type_to_an_Application_on_Windows&amp;action=edit&amp;redlink=1"  title="Discussion about the content page [t]" accesskey="t">Discussion</a></span></li>
			</ul>
</div>
<div id="p-variants" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-variants-label">
	<h3 id="mw-vector-current-variant">
		</h3>
	<h3 id="p-variants-label"><span>Variants</span><a href="#"></a></h3>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>
				</div>
				<div id="right-navigation">
					<div id="p-views" role="navigation" class="vectorTabs" aria-labelledby="p-views-label">
	<h3 id="p-views-label">Views</h3>
	<ul>
					<li id="ca-view"><span><a href="http://wiki.qt.io/Assigning_a_file_type_to_an_Application_on_Windows" >Read</a></span></li>
					<li id="ca-viewsource" class="selected"><span><a href="http://wiki.qt.io/index.php?title=Assigning_a_file_type_to_an_Application_on_Windows&amp;action=edit"  title="This page is protected.&#10;You can view its source [e]" accesskey="e">View source</a></span></li>
					<li id="ca-history" class="collapsible"><span><a href="http://wiki.qt.io/index.php?title=Assigning_a_file_type_to_an_Application_on_Windows&amp;action=history"  title="Past revisions of this page [h]" accesskey="h">View history</a></span></li>
			</ul>
</div>
<div id="p-cactions" role="navigation" class="vectorMenu emptyPortlet" aria-labelledby="p-cactions-label">
	<h3 id="p-cactions-label"><span>Actions</span><a href="#"></a></h3>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>
<div id="p-search" role="search">
	<h3><label for="searchInput">Search</label></h3>
	<form action="http://wiki.qt.io/index.php" id="searchform">
					<div id="simpleSearch">
					<input type="search" name="search" placeholder="Search" title="Search Qt Wiki [f]" accesskey="f" id="searchInput" /><input type="hidden" value="Special:Search" name="title" /><input type="submit" name="fulltext" value="Search" title="Search the pages for this text" id="mw-searchButton" class="searchButton mw-fallbackSearchButton" /><input type="submit" name="go" value="Go" title="Go to a page with this exact name if exists" id="searchButton" class="searchButton" />		</div>
	</form>
</div>
				</div>
			</div>
			<div id="mw-panel">
					<div id="p-logo" role="banner"><a style="background-image: url(http://wiki.qt.io/skins/common/images/wiki.png);" href="http://wiki.qt.io/Main_Page"  title="Visit the main page"></a></div>
				<div class="portal" role="navigation" id='p-navigation' aria-labelledby='p-navigation-label'>
	<h3 id='p-navigation-label'>Navigation</h3>
	<div class="body">
		<ul>
			<li id="n-mainpage-description"><a href="http://wiki.qt.io/Main_Page" title="Visit the main page [z]" accesskey="z">Main page</a></li>
			<li id="n-recentchanges"><a href="http://wiki.qt.io/Special:RecentChanges" title="A list of recent changes in the wiki [r]" accesskey="r">Recent changes</a></li>
			<li id="n-randompage"><a href="http://wiki.qt.io/Special:Random" title="Load a random page [x]" accesskey="x">Random page</a></li>
			<li id="n-help"><a href="https://www.mediawiki.org/wiki/Special:MyLanguage/Help:Contents" title="The place to find out">Help</a></li>
		</ul>
	</div>
</div>
<div class="portal" role="navigation" id='p-tb' aria-labelledby='p-tb-label'>
	<h3 id='p-tb-label'>Tools</h3>
	<div class="body">
		<ul>
			<li id="t-whatlinkshere"><a href="http://wiki.qt.io/Special:WhatLinksHere/Assigning_a_file_type_to_an_Application_on_Windows" title="A list of all wiki pages that link here [j]" accesskey="j">What links here</a></li>
			<li id="t-recentchangeslinked"><a href="http://wiki.qt.io/Special:RecentChangesLinked/Assigning_a_file_type_to_an_Application_on_Windows" title="Recent changes in pages linked from this page [k]" accesskey="k">Related changes</a></li>
			<li id="t-specialpages"><a href="http://wiki.qt.io/Special:SpecialPages" title="A list of all special pages [q]" accesskey="q">Special pages</a></li>
			<li id="t-info"><a href="http://wiki.qt.io/index.php?title=Assigning_a_file_type_to_an_Application_on_Windows&amp;action=info">Page information</a></li>
		</ul>
	</div>
</div>
			</div>
		</div>
		<div id="footer" role="contentinfo">
							<ul id="footer-places">
											<li id="footer-places-terms"><a href='https://developer.qtcloudservices.com/legal/terms'>Käyttöehdot</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
					<li id="footer-poweredbyico">
						<a href="http://www.mediawiki.org/"><img src="http://wiki.qt.io/skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31" /></a>
					</li>
				</ul>
						<div style="clear:both"></div>
		</div>
		<script>/*<![CDATA[*/window.jQuery && jQuery.ready();/*]]>*/</script><script>if(window.mw){
mw.loader.state({"site":"loading","user":"ready","user.groups":"ready"});
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.action.edit.collapsibleFooter","mediawiki.user","mediawiki.hidpi","mediawiki.page.ready","mediawiki.searchSuggest","skins.vector.collapsibleNav"],null,true);
}</script>
<script src="http://wiki.qt.io/load.php?debug=false&amp;lang=en&amp;modules=site&amp;only=scripts&amp;skin=vector&amp;*"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-54043535-2', 'auto');
  ga('send', 'pageview');

</script>
<script>if(window.mw){
mw.config.set({"wgBackendResponseTime":204});
}</script>
	</body>

<!-- Mirrored from wiki.qt.io/index.php?title=Assigning_a_file_type_to_an_Application_on_Windows&action=edit by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 05 Nov 2015 10:54:42 GMT -->
</html>
